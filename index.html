<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlipBuku HTML5 ‚Äî Viewer Seakan Flash</title>

  <style>
    :root{
      --bg:#0a2540;
      --panel:#103d68;
      --accent:#ffd34d;
      --text:#eef6ff;
      --muted:#b8d3f0;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg,#123e70,#0f3359);padding:10px 14px;
      border-bottom:2px solid #0b2846;position:sticky;top:0;z-index:5}
    .brand{display:flex;gap:10px;align-items:center;font-weight:600}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .sel{appearance:none;border:1px solid #0b2846;background:#0f3359;color:var(--text);padding:8px 10px;border-radius:10px;font-size:14px}
    .sel:focus{outline:2px solid #124b82}
    .btn{appearance:none;border:1px solid #0b2846;background:#0f3359;color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-size:14px}
    .btn:hover{border-color:#124b82}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    input[type="file"]{display:none}
    label.btn{display:inline-flex;align-items:center;gap:8px}
    .wrap{height:calc(100% - 62px);display:grid;grid-template-columns:220px 1fr}
    .sidebar{background:#0e365f;border-right:1px solid #0b2846;padding:12px;overflow:auto}
    .sidebar h3{margin:6px 0 10px 0;font-size:14px;color:var(--muted)}
    .progress{height:8px;background:#0b2846;border-radius:10px;overflow:hidden;margin:8px 0}
    .progress>span{display:block;height:100%;width:0;background:var(--accent);transition:width .2s}
    .thumbs{display:grid;gap:8px;grid-template-columns:repeat(auto-fill, minmax(84px, 1fr))}
    .thumbs img{width:100%;border-radius:8px;border:1px solid #0b2846;cursor:pointer;aspect-ratio:3/4;object-fit:cover}
    .stage{position:relative;display:grid;place-items:center;background:#09223d}
    .book-wrap{transform-origin:center;transition:transform .15s ease}
    #book{width:100%;height:100%;max-width:2200px;max-height:97vh}
    .statusbar{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.35);
      padding:6px 10px;border-radius:10px;font-size:12px;backdrop-filter:blur(4px)}
    .jumpto{display:flex;gap:6px;align-items:center;margin-top:8px}
    .jumpto input{width:90px;padding:6px;border-radius:8px;border:1px solid #0b2846;
      background:#0f3359;color:var(--text)}
    .hint{color:var(--muted);font-size:12px}
    .credit{position:fixed;right:10px;bottom:10px;font-size:12px;color:var(--muted)}
    :fullscreen #book{max-width:95vw;max-height:95vh}
    :-webkit-full-screen #book{max-width:95vw;max-height:95vh}
      /* Mod bacaan skrin penuh */
    body.fs-read header, body.fs-read .sidebar{display:none}
    body.fs-read .wrap{grid-template-columns:1fr}
    body.fs-read .stage{background:#000}
    .fshint{display:none;position:fixed;top:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.65);color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;z-index:9999}
    .turn{display:none;position:absolute;top:50%;transform:translateY(-50%);z-index:6;border:1px solid rgba(255,255,255,.3);background:rgba(0,0,0,.45);color:#fff;padding:10px 12px;border-radius:999px;backdrop-filter:blur(2px);cursor:pointer}
    .turn:hover{background:rgba(0,0,0,.65)}
    .turn.left{left:10px}
    .turn.right{right:10px}
    body.fs-read .turn{display:block}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      try { pdfjsLib.GlobalWorkerOptions.workerSrc = (location.protocol === 'file:') ? './pdf.worker.min.js' : 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; } catch(e){}
    }
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> <span>FlipBuku HTML5</span></div>
    <div class="tools">
      <label class="btn" title="Muat naik fail (PDF, DOCX, TXT, JPG/PNG/WEBP)">
        <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt,.png,.jpg,.jpeg,.webp" />
        üìÅ Muat Naik Fail
      </label>
      <select id="paperSel" class="sel" title="Saiz kertas">
        <option value="auto" selected>Saiz: Auto</option>
        <option value="A5">A5</option>
        <option value="A4">A4</option>
        <option value="A3">A3</option>
        <option value="Letter">Letter</option>
      </select>
      <select id="orientSel" class="sel" title="Orientasi">
        <option value="portrait" selected>Potret</option>
        <option value="landscape">Landskap</option>
      </select>
      <select id="spreadSel" class="sel" title="Mod muka">
        <option value="double" selected>Dwi-muka</option>
        <option value="single">Satu muka</option>
      </select>
      <button id="prevBtn" class="btn" disabled>‚óÄÔ∏é Muka sebelum</button>
      <button id="nextBtn" class="btn" disabled>Muka seterusnya ‚ñ∂Ô∏é</button>
      <button id="fsBtn" class="btn" disabled>‚õ∂ Skrin penuh</button>
      <button id="zoomOut" class="btn" disabled>‚àí Kecil</button>
      <button id="zoomIn" class="btn" disabled>+ Besar</button>
    </div>
  </header>

  <div class="wrap">
    <aside class="sidebar">
      <h3>Status Muat</h3>
      <div class="progress"><span id="bar"></span></div>
      <div id="info" class="hint">Tiada fail dibuka.</div>
      <div class="jumpto">
        <input id="goto" type="number" min="1" placeholder="Pergi ke muka‚Ä¶" />
        <button id="gotoBtn" class="btn" disabled>Pergi</button>
      </div>
      <div class="hint">Sokongan: <strong>PDF</strong>, <strong>DOCX</strong> (Word), <strong>TXT</strong>, <strong>JPG/PNG/WEBP</strong>.<br/>Format lain (DOC, PPT/PPTX) ‚Üí eksport ke PDF dahulu.</div>
      <h3>Pratonton</h3>
      <div id="thumbs" class="thumbs"></div>
    </aside>

    <div id="fsHint" class="fshint">Tekan <strong>Esc</strong> untuk keluar skrin penuh</div>
    <main id="stage" class="stage">
      <div id="bookWrap" class="book-wrap">
        <div id="book"></div>
      </div>
      <button id="prevOver" class="turn left" aria-label="Halaman sebelum">‚óÄ</button>
      <button id="nextOver" class="turn right" aria-label="Halaman seterusnya">‚ñ∂</button>
      <div class="statusbar" id="status">Sedia</div>
    </main>
  </div>

  <div class="credit">Dibina dengan PDF.js, Mammoth & StPageFlip</div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const bar = document.getElementById('bar');
    const info = document.getElementById('info');
    const thumbs = document.getElementById('thumbs');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const fsBtn = document.getElementById('fsBtn');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');
    const gotoInput = document.getElementById('goto');
    const gotoBtn = document.getElementById('gotoBtn');
    const bookEl = document.getElementById('book');
    const bookWrap = document.getElementById('bookWrap');
    const status = document.getElementById('status');
    const stageEl = document.getElementById('stage');
    const paperSel = document.getElementById('paperSel');
    const orientSel = document.getElementById('orientSel');
    const spreadSel = document.getElementById('spreadSel');

    let pageFlip = null;
    let scale = 1;
    const DPR = Math.max(1, window.devicePixelRatio || 1);
    let lastImages = null; // simpan hasil render untuk re-init mengikut saiz kertas

    const PAPER_SIZES_MM = { A3:{w:297,h:420}, A4:{w:210,h:297}, A5:{w:148,h:210}, Letter:{w:216,h:279} };
    function computePageSize(){
      const p = paperSel.value; const o = orientSel.value; // portrait/landscape
      // Asas: A4 1024√ó1448 untuk nisbah sqrt(2)
      let w=1024, h=Math.round(1024*1.4142);
      if (p !== 'auto' && PAPER_SIZES_MM[p]){
        const mm = PAPER_SIZES_MM[p];
        const ratio = mm.h / mm.w; // potret
        h = Math.round(w * ratio);
      }
      if (o === 'landscape'){ const tmp=w; w=h; h=tmp; }
      return {w,h};
    }

    const isImage = (name, type) => /(\.png|\.jpe?g|\.webp)$/i.test(name) || /^image\//.test(type);
    const isTxt = (name, type) => /\.txt$/i.test(name) || type === 'text/plain';
    const isDocx = (name, type) => /\.docx$/i.test(name) || /wordprocessingml\.document$/.test(type);
    const isPdf  = (name, type) => /\.pdf$/i.test(name) || type === 'application/pdf';

    function enableControls(on){ [prevBtn,nextBtn,fsBtn,zoomIn,zoomOut,gotoBtn].forEach(b=>b.disabled=!on); }
    function setStatus(t){ status.textContent = t; }
    function setZoom(newScale){ scale = Math.max(0.5, Math.min(3, newScale)); bookWrap.style.transform = `scale(${scale})`; }
    function fitToStage(mult=0.98){
      const sW = stageEl.clientWidth || window.innerWidth;
      const sH = stageEl.clientHeight || window.innerHeight;
      const bW = bookEl.clientWidth || 1024;
      const bH = bookEl.clientHeight || 720;
      const k = Math.min(sW / bW, sH / bH) * mult;
      setZoom(k);
    }
    zoomIn.addEventListener('click', ()=> setZoom(scale + 0.1));
    zoomOut.addEventListener('click', ()=> setZoom(scale - 0.1));
    fsBtn.addEventListener('click', async ()=>{
      const el = document.documentElement;
      if (!document.fullscreenElement){ await el.requestFullscreen().catch(()=>{}); }
      else { await document.exitFullscreen().catch(()=>{}); }
    });
    const prevOver = document.getElementById('prevOver');
    const nextOver = document.getElementById('nextOver');
    prevOver.addEventListener('click', ()=> pageFlip && pageFlip.flipPrev());
    nextOver.addEventListener('click', ()=> pageFlip && pageFlip.flipNext());
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowLeft') pageFlip && pageFlip.flipPrev();
      if (e.key === 'ArrowRight') pageFlip && pageFlip.flipNext();
      if (e.key.toLowerCase() === 'f') fsBtn.click();
    });
    // Tukar konfigurasi saiz kertas/orientasi/mode secara langsung
    function rebuildFlip(){ if (!lastImages) return; if(pageFlip){ pageFlip.destroy(); pageFlip=null; } bookEl.innerHTML=''; initFlip(lastImages); setTimeout(()=>{ fitToStage(0.98); pageFlip && pageFlip.update(); }, 30); }
    paperSel.addEventListener('change', rebuildFlip);
    orientSel.addEventListener('change', rebuildFlip);
    spreadSel.addEventListener('change', rebuildFlip);

    prevBtn.addEventListener('click', ()=> pageFlip && pageFlip.flipPrev());
    nextBtn.addEventListener('click', ()=> pageFlip && pageFlip.flipNext());
    gotoBtn.addEventListener('click', ()=>{ if (!pageFlip) return; const n = parseInt(gotoInput.value,10); if (!n) return; pageFlip.turnToPage(Math.max(0, Math.min(pageFlip.getPageCount()-1, n-1))); });

    function resetUI(){ thumbs.innerHTML=''; bar.style.width='0%'; info.textContent='Memuat muka surat‚Ä¶'; setStatus('Memuat‚Ä¶'); setZoom(1); if (pageFlip){ pageFlip.destroy(); pageFlip=null;} bookEl.innerHTML=''; enableControls(false); }

    async function loadPDF(arrayBuffer){
      resetUI();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      const total = pdf.numPages; info.textContent = `Dikesan ${total} muka surat.`;
      const est = computePageSize();
      const fitW = stageEl.clientWidth || window.innerWidth;
      const targetWidth = Math.min(4096, Math.max(2000, Math.floor(fitW * DPR * 1.2)));
      const images = [];
      for (let i=1;i<=total;i++){
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({scale: 1});
        const scaledViewport = page.getViewport({scale: targetWidth / viewport.width});
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
        canvas.width = Math.floor(scaledViewport.width); canvas.height = Math.floor(scaledViewport.height);
        await page.render({canvasContext: ctx, viewport: scaledViewport, intent:'print'}).promise;
        const dataURL = canvas.toDataURL('image/png'); images.push(dataURL);
        const th = document.createElement('img'); th.src = dataURL; th.title = `Muka ${i}`; th.addEventListener('click', ()=> pageFlip && pageFlip.turnToPage(i-1)); thumbs.appendChild(th);
        bar.style.width = Math.round((i/total)*100)+'%'; setStatus(`Memuat muka ${i}/${total}‚Ä¶`);
      }
      initFlip(images);
    }

    async function loadTXT(text){
      resetUI(); const images = []; const pageW=1024, pageH=1448, margin=80, lineH=32; const maxWidth=pageW - margin*2; const words=(text||'').split(/\s+/);
      let canvas=document.createElement('canvas'); canvas.width=pageW; canvas.height=pageH; let ctx=canvas.getContext('2d');
      const start=()=>{ctx.fillStyle='#fff';ctx.fillRect(0,0,pageW,pageH);ctx.fillStyle='#000';ctx.font='20px Georgia, serif';}; start();
      let x=margin, y=margin+20;
      function newPage(){ images.push(canvas.toDataURL('image/png')); const th=document.createElement('img'); th.src=images.at(-1); th.title=`Muka ${images.length}`; th.addEventListener('click', ()=> pageFlip && pageFlip.turnToPage(images.length-1)); thumbs.appendChild(th); canvas=document.createElement('canvas'); canvas.width=pageW; canvas.height=pageH; ctx=canvas.getContext('2d'); start(); x=margin; y=margin+20; }
      for (const w of words){ const m=ctx.measureText(w+' '); if (x+m.width>margin+maxWidth){ x=margin; y+=lineH; } if (y+lineH>pageH-margin){ newPage(); } ctx.fillText(w+' ', x, y); x+=m.width; }
      images.push(canvas.toDataURL('image/png')); const th=document.createElement('img'); th.src=images.at(-1); th.title=`Muka ${images.length}`; th.addEventListener('click', ()=> pageFlip && pageFlip.turnToPage(images.length-1)); thumbs.appendChild(th); bar.style.width='100%'; initFlip(images);
    }

    async function loadImages(files){ resetUI(); const images=[]; let i=0; for (const f of files){ i++; const url=URL.createObjectURL(f); images.push(url); const th=document.createElement('img'); th.src=url; th.title=`Muka ${i}`; th.addEventListener('click', ()=> pageFlip && pageFlip.turnToPage(i-1)); thumbs.appendChild(th); bar.style.width=Math.round((i/files.length)*100)+'%'; } initFlip(images); }

    async function loadDOCX(arrayBuffer){ resetUI(); info.textContent='Menukarkan DOCX ke HTML‚Ä¶'; try{ const result=await window.mammoth.convertToHtml({arrayBuffer}); const tmp=document.createElement('div'); tmp.innerHTML=result.value; const text=tmp.innerText||''; await loadTXT(text);}catch(e){ alert('DOCX tidak dapat diproses. Sila eksport ke PDF.'); console.error(e);} }

    function initFlip(images){
      setStatus('Menjana buku‚Ä¶');
      const {w, h} = computePageSize();
      const doubleMode = (spreadSel.value === 'double');
      pageFlip = new St.PageFlip(bookEl, {
        width: w,
        height: h,
        size: 'stretch',
        showCover: true,
        maxShadowOpacity: 0.4,
        mobileScrollSupport: false,
        usePortrait: !doubleMode,
        drawShadow: true,
      });
      pageFlip.loadFromImages(images);
      lastImages = images;
      enableControls(true);
      setTimeout(()=>{ fitToStage(0.98); pageFlip.update(); }, 50);
      setStatus(`Siap ‚Ä¢ ${images.length} muka surat`); info.textContent = `Siap dimuat: ${images.length} muka surat.`;
      pageFlip.on('flip', (e)=>{ const pg=(e.data+1); status.textContent = `Muka ${pg} / ${pageFlip.getPageCount()}`; });
    }

    fileInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files || []);
      if (files.length === 0) return;
      if (files.length > 1 && files.every(f=>isImage(f.name,f.type))){ await loadImages(files); return; }
      const f = files[0]; const name=f.name||''; const type=f.type||''; const reader=new FileReader();
      if (isPdf(name,type)){ reader.onload=ev=> loadPDF(ev.target.result); reader.readAsArrayBuffer(f); }
      else if (isDocx(name,type)){ reader.onload=ev=> loadDOCX(ev.target.result); reader.readAsArrayBuffer(f); }
      else if (isTxt(name,type)){ reader.onload=ev=> loadTXT(ev.target.result); reader.readAsText(f,'utf-8'); }
      else if (isImage(name,type)){ await loadImages([f]); }
      else { alert('Format tidak disokong terus. Sila guna PDF, DOCX, TXT, atau imej. Untuk DOC/PPT, eksport ke PDF.'); }
    });

    window.addEventListener('dragover', e=>{ e.preventDefault(); });
    window.addEventListener('drop', e=>{ e.preventDefault(); const f=e.dataTransfer.files[0]; if (!f) return; const dt=new DataTransfer(); dt.items.add(f); fileInput.files=dt.files; const change=new Event('change'); fileInput.dispatchEvent(change); });
    window.addEventListener('resize', ()=>{ fitToStage(0.98); pageFlip && pageFlip.update(); });
    document.addEventListener('fullscreenchange', ()=>{ 
      const fs = !!document.fullscreenElement; 
      document.body.classList.toggle('fs-read', fs);
      const hint = document.getElementById('fsHint');
      if (hint) hint.style.display = fs ? 'block' : 'none';
      fitToStage(fs ? 0.995 : 0.98); pageFlip && pageFlip.update();
      // Auto sorok hint selepas 3s
      if (fs && hint){ setTimeout(()=> hint.style.display='none', 3000); }
    });
  </script>
</body>
</html>
